## 브라우저 랜더링 과정

브라우저의 핵심 동작은 HTML, CSS, JS를 통해 사용자가 인터렉션할 수 있는 페이지를 구축하는 일이다.
메인, 워커, 컴포지터, 레스터 스레드를 가지고 있다.

1. DOM 트리 구축
2. CSSOM 트리 구축
3. 자바스크립트 실행
4. 랜더트리 구축
5. 레이아웃 생성 (랜더트리 배치)
6. 페인팅 (랜더트리 그리기)

## 구문 분석 단계 (Parsing)

브라우저는 수신된 청크를 전달받아 구문을 분석하기 시작한다. 구문 분석 단계는 브라우저가 네트워크를
통해 전달받은 데이터를 통해 DOM 혹은 CSSOM을 생성하는 단계이다. 

### 1. DOM 트리 구축

랜더링 엔진에서 아래 작업을 진행된다. HTML 구문 분석 단계는 토큰화와 DOM 트리 생성이다.
- HTML 토큰은 시작 및 종료 태그 그리고 속성 이름 및 값을 포함한다.

1) 브라우저는 전달받은 HTML파일을 파싱하기 시작한다. 
2) HTML에 정의된 인코딩 규칙(e.g. UTF-8)에 따라 개별 문자로 변환한다.
3) 변환된 문자열을 W3C 표준에 지정된 고유 토큰으로 반환하는 토큰화 과정을 거친다. (토큰화)
4) 구문 분석기는 토큰화된 입력을 분석하여 해당 토큰들에 대한 속성과 규칙을 정의하는 객체(DOM의 노드가 되는)로 반환한다.
5) HTML 마크업 파일에 정의된 여러 태그간의 관계(자식, 형제)를 해석하여 트리 구조로 연결한다.

![Dom tree process](./images/dom-tree-process.png)

### 2. 리소스 요청

랜더링 엔진에 의해 HTML 파일이 분석되는 과정에 img, link, script와 같은 태그를 만나면
부가적인 리소스를 요청하거나 캐시로부터 가져오기 위해 네트워크 스레드에 해당 작업을 요청한다.

### 3. CSSOM 트리 구축

DOM 트리와 동일한 방식으로 CSS 파일을 분석하여 CSSOM 트리를 구축한다.
- CSSOM 트리는 사용자 에이전트에서 default로 제공하는 스타일 시트를 포함한다. 
- 브라우저는 노드에 적용 가능한 가장 일반적인 규칙부터 적용한다.
- 이후 재귀적으로 보다 구체적인 계산된 스타일을 수정해나간다. 이를 속성 값을 캐스케이드한다. 라고 한다.

CSSOM 트리를 구축하는 것은 매우 빨라 웹 성능 최적화 측면에서 크게 기여할 수 있는 단계는 아니다.

1) 브라우저는 CSS 규칙을 이해할 수 있고 작업을 진행할 수 있도록 스타일 맵으로 변환한다.
2) 브라우저는 CSS에 있는 각각의 규칙에 따라 트리 노드를 생성한다.
3) CSS 선택기에 기반해서 부모 노드, 자식 노드, 형제 노드와의 관계를 통해 트리를 구축한다.

![CSSOM tree process](./images/cssom-process.png)

### 4. 랜더트리 구축

1) 생성된 DOM, CSSOM 트리를 합성해서 랜더링 트리를 생성한다.
2) 랜더트리는 DOM 트리의 루트부터 시작하여 눈에 보이는 노드를 순회하며 만들어진다.
  - 즉, 표시되지 않는 메타태그, `display: none;` 속성을 가진 노드 등은 포함되지 않는다.

![Render tree process](./images/render-tree-process.avif)

### 5. 레이아웃 생성 (랜더트리 배치)

랜더트리를 기반으로 각각의 요소들이 위치해야 하는 기하학적인 구조를 배치하는 결정하는 과정이다.
랜더트리가 한번 만들어지면 레이아웃이 시작되는데, 랜더 트리는 눈에 보이지 않아도 계산된 스타일과
함께 어떤 노드가 화면에 표시될지 식별한다.

1) 랜더트리에 있는 모든 노드의 너비, 높이, 위치를 결정한다.
2) 뷰포트 기반으로 페이지에서 각각의 객체의 크기와 위치를 계산한다.
  - 이때, 이미지와 같이 정적 자원을 받아와서 랜더링되어야 하는 컨텐츠의 경우 사이즈를 모른다. 이를
  위해 이미지 표시 공간을 남겨둔다.

![Layout process](./images/layout-process.png)

### 6. 페인팅 (랜더트리 그리기)

레이아웃 단계에서 계산된 각 박스를 실제 화면의 픽셀로 반환한다. 페인팅에서 텍스트, 색깔, 경계 그림자 및
버튼이나 이미지 같은 대체 요소를 포함하여 모든 요소의 시각적인 부분을 화면에 그리는 작업을 포함한다.

브라우저는 이 작업을 매우 빠르게 해야 한다.

- 레이어 승격(`translate3d(0, 0,0)`)이나 `will-change`와 같은 속성으로 미치 최적화 준비를
할 수 있다.
- 위에서 언급한 리플로우를 발생시킬 수 있는 늦게 전달받은 이미지와 같은 자원이 필요한 레이아웃의 경우
리플로우를 방지하기 위해 이미지의 실제 사이즈를 미리 대입해두면 이를 방지할 수 있다.

### reference

- [웹페이지를 표시한다는 것: 브라우저는 어떻게 동작하는가](https://developer.mozilla.org/ko/docs/Web/Performance/How_browsers_work)
- [브라우저의 렌더링 과정](https://medium.com/%EA%B0%9C%EB%B0%9C%EC%9E%90%EC%9D%98%ED%92%88%EA%B2%A9/%EB%B8%8C%EB%9D%BC%EC%9A%B0%EC%A0%80%EC%9D%98-%EB%A0%8C%EB%8D%94%EB%A7%81-%EA%B3%BC%EC%A0%95-5c01c4158ce)






